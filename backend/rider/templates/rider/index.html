<!-- <script>
 let socket= new WebSocket(
    url="ws://"
        +window.location.host
        +'/ws/rider/'
        +"dadul"
        +"/"
 )

 socket.onopen=()=>{
    console.log(`Connection open to ${socket.url}`);

    socket.onmessage=(e)=>{
        const data=JSON.parse(e.data);
        console.log('[RECEIVING]',data);
    }

    socket.onclose=()=>{
        console.log(`Connection closed to ${socket.url}`)
    }

    data={
            'location':{
                'longitude':88.6128468,
                'latitude':27.3278476,
                 },
            'search':true
        }
        // socket.send(JSON.stringify(data))
    setInterval(()=>{
        // 88.6128468 27.3278476
        data={
            'location':{
                'longitude':88.6128468,
                'latitude':27.3278476,
                 },
            'search':true
        }
        socket.send(JSON.stringify(data));
    },2000) 
 }
</script> -->

{% if user.is_authenticated %}
<h1>Logged in User:{{ useremail }} </h1>
<a href="{% url 'rider_logout' %}"> <input type="button" value="Log Out"></a>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Rider Location</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
    <!-- <link href="map.css" rel="stylesheet"> -->
</head>
<body>
    {{ username|json_script:"rider-name" }}



    <div class="d-flex align-items-center text-center" style="min-height: 100vh">
        <div class="box w-100 text-success">
          <h2>This is the test location for rider {{username}} </h3>

          <label for="lat">Latitude</label>
          <input id="lat" type="text"  id="latitude" value="27.3283">
          <label for="long">longitude</label>
          <input id='long' type="text" id="longitude" value="88.6124">
          <br>
          <div>
            <label class="conatiner h5 m-4">All
                <input type="radio"  name="cars" id="allRadio">
            </label>
            <label class="conatiner h5 m-4">Normal
                <input type="radio"  name="cars" id="normalRadio" checked>
            </label>
            <label class="conatiner h5">Luxury
                <input type="radio" name="cars" id="luxuryRadio">
            </label>
          </div>
          <br>
          <button class="btn btn-primary" id="searchAndStopBtn" onclick="searchAndStop()">Search</button>
          <div class="col ">
            <h4 id="nearbyDrivers">Number of nearby drivers: None</h1>
                <h3>My Maps Demo</h3>
                <div class="container text-center">   
                    <div  id="map" style="height: 500px;width: 1200px;"></div>
                </div>
             
        </div>
          
    </div>
    </div>
         
    

           

    <!-- prettier-ignore -->


    <script>
    let sendInterval;
    let mapView;
    let map;
    let layer;
    const riderName = JSON.parse(document.getElementById('rider-name').textContent);
        console.log(riderName)
        const chatSocket = new WebSocket(
         'ws://'
         + window.location.host
         + '/ws/rider/'
         + riderName
         + '/'
     );

     var osmTile=new ol.layer.Tile({
        title:'Open Street Map',
        visible:true,
        source:new ol.source.OSM()
     })
    
//      layer = new ol.layer.Vector({
//      source: new ol.source.Vector({
//          features: [
//              new ol.Feature({
//                  geometry: new ol.geom.Point(ol.proj.fromLonLat([88.6124,27.3283]))
//              })
//          ]
//      })
//  });

     
        function searchAndStop(){
            const btn=document.getElementById('searchAndStopBtn');
            if (btn.textContent=='Search'){ 
                // Search is same as book as we are searching to find a car to allocate the user
                let normalRadio=document.getElementById('normalRadio')
                let allRadio=document.getElementById('allRadio')
                let luxuryRadio=document.getElementById('luxuryRadio')
                let carType=null
                if (normalRadio.checked ){
                    carType='normal'
                }

                else if (luxuryRadio.checked){
                    carType='luxury'
                }
                else if(allRadio.checked){
                    carType=null
                }
                    
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger');
                btn.textContent='Stop Search';
                let lat=document.getElementById('lat').value;
                let long=document.getElementById('long').value;
                let mapClear=document.getElementById('map').innerText=""
                mapView=new ol.View({
                center:ol.proj.fromLonLat([long,lat]),
                zoom:14,
                });
                map=new ol.Map({
                target:'map',
                view:mapView
                })
                layer = new ol.layer.Vector({
     source: new ol.source.Vector({
         features: [
             new ol.Feature({
                 geometry: new ol.geom.Point(ol.proj.fromLonLat([long,lat]))
             })
         ]
     })
 });

                map.addLayer(osmTile);
                map.addLayer(layer)
                chatSocket.send(JSON.stringify({
                                    'newSearch':true,
                                    'carType':carType
                                    })
                                );
                sendInterval= setInterval(sendServer,5000,true,carType,lat,long);
            }
            else{
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-danger');
                btn.textContent='Search';
                clearInterval(sendInterval);
                chatSocket.send(JSON.stringify({
              'search':false}));
                
            }


        }



    function sendServer(search,carType,lat,long){
        chatSocket.send(JSON.stringify({
             'search':search,
             'carType':carType,
             'location': {'latitude': lat ,
                           'longitude':long,
                         }
                 }));
            
        } 

   

     chatSocket.onopen=function(e){
         console.log(chatSocket.url)
     }
         
     
     chatSocket.onmessage = function(e) {
         const data = JSON.parse(e.data);
         console.log(data);
         drivers=data['drivers'];
         if (drivers.length){
            nearby=document.getElementById('nearbyDrivers');
            nearby.textContent=`Number of nearby drivers: ${drivers.length}`
            for(const driver of drivers){
                layer.getSource().addFeature(createMarker(driver.longitude, driver.latitude));
                }
            }
           
         };
         


     chatSocket.onclose = function(e) {
         console.error('Chat socket closed unexpectedly');
     };

     

    //  mapView=new ol.View({
    //     center:ol.proj.fromLonLat([88.6124,27.3283]),
    //     zoom:16,
    //  });

    //   map=new ol.Map({
    //     target:'map',
    //     view:mapView
    //  })
  
    function createMarker(lng, lat) {
    return new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([parseFloat(lng), parseFloat(lat)])),
    });
}



//    map.addLayer(osmTile);
//    map.addLayer(layer)




 </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js" integrity="sha384-zYPOMqeu1DAVkHiLqWBUTcbYfZ8osu1Nd6Z89ify25QV9guujx43ITvfi12/QExE" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js" integrity="sha384-Y4oOpwW3duJdCWv5ly8SCFYWqFDsfob/3GkgExXKV4idmbt98QcxXYs9UoXAB7BZ" crossorigin="anonymous"></script>

</body>
</html>
{% else %}
<a href="{% url 'rider_login' %}"> <input type="button" value="Redirect to login"></a>
{% endif %}


